
<div id="lms-access-control" class="mt-3">
  <h5>LMS Access Control</h5>
  <div class="form-group form-check">
    <input type="checkbox" class="form-check-input" id="only-while-active-in-lms">
    <label class="form-check-label" for="only-while-active-in-lms">Only show while user have active exam attempt with this task in LMS</label>
  </div>
  <div class="form-group">
    <label for="lms-attribute-logic">LMS attribute logic</label>
    <textarea class="form-control" id="lms-attribute-logic" rows="3" placeholder="Example: (role == 'pro') or (department == 'infosec' and level >= 3)"></textarea>
    <small class="form-text text-muted">Use a Python-like boolean expression using your LMS attribute keys. Allowed operators: and, or, not, ==, !=, in, not in, >, >=, <, <=</small>
  </div>
  <div class="form-group">
    <button id="save-lms-requirements" class="btn btn-primary">Save LMS Requirements</button>
  </div>
</div>
<hr/>
<div id="prerequisite-add-form"></div>
<script>
(function(){
  function loadRequirements(){
    CTFd.fetch(`/api/v1/challenges/${window.CHALLENGE_ID}/requirements`,{
      method:'GET',
      credentials:'same-origin',
      headers:{'Content-Type':'application/json','Accept':'application/json'}
    }).then(r=>r.json()).then(r=>{
      if(!r.success) return;
      window.__CURRENT_REQUIREMENTS__ = r.data || {};
      document.getElementById('only-while-active-in-lms').checked = !!(window.__CURRENT_REQUIREMENTS__.only_while_active_in_lms);
      document.getElementById('lms-attribute-logic').value = window.__CURRENT_REQUIREMENTS__.lms_attribute_logic || '';
    });
  }
  function saveRequirements(){
    const merged = Object.assign({}, window.__CURRENT_REQUIREMENTS__ || {});
    const onlyActive = document.getElementById('only-while-active-in-lms').checked;
    let logic = document.getElementById('lms-attribute-logic').value || '';
    logic = logic.trim();
    merged.only_while_active_in_lms = onlyActive;
    if(logic){
      merged.lms_attribute_logic = logic;
    } else {
      delete merged.lms_attribute_logic;
    }
    CTFd.fetch(`/api/v1/challenges/${window.CHALLENGE_ID}`,{
      method:'PATCH',
      credentials:'same-origin',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify({requirements: merged})
    }).then(r=>r.json()).then(resp=>{
      if(resp && resp.success){
        // reload to reflect saved settings
        loadRequirements();
      } else {
        alert('Failed to save LMS requirements');
      }
    }).catch(()=>alert('Failed to save LMS requirements'));
  }
  document.addEventListener('DOMContentLoaded', function(){
    loadRequirements();
    const btn = document.getElementById('save-lms-requirements');
    if(btn){ btn.addEventListener('click', function(e){ e.preventDefault(); saveRequirements(); }); }
  });
})();
</script>